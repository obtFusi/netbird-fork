# NetBird Router-Peer Defense-in-Depth Configuration
# This file configures kernel-level network security for the router-peer.
# Install to: /etc/sysctl.d/99-netbird-hardening.conf
# Apply with: sudo sysctl -p /etc/sysctl.d/99-netbird-hardening.conf

# ═══════════════════════════════════════════════════════════════════════════
# ANTI-SPOOFING (Reverse Path Filtering)
# ═══════════════════════════════════════════════════════════════════════════
# Strict mode (1): Drop packets if reply would go out different interface
# This prevents IP spoofing attacks where attacker forges source IP
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log martian packets (packets with impossible source addresses)
# Useful for detecting spoofing attempts
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# ═══════════════════════════════════════════════════════════════════════════
# ICMP REDIRECT PROTECTION
# ═══════════════════════════════════════════════════════════════════════════
# Don't accept ICMP redirects (prevents route hijacking)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Don't send ICMP redirects (we're a router, but shouldn't redirect)
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# ═══════════════════════════════════════════════════════════════════════════
# IP FORWARDING (Required for router functionality)
# ═══════════════════════════════════════════════════════════════════════════
net.ipv4.ip_forward = 1

# ═══════════════════════════════════════════════════════════════════════════
# CONNTRACK TUNING (for high connection counts)
# ═══════════════════════════════════════════════════════════════════════════
# Increase maximum tracked connections (default is often 65536)
net.netfilter.nf_conntrack_max = 262144

# Reduce timeout for established TCP connections (default 432000 = 5 days)
# 3600 seconds = 1 hour is reasonable for VPN traffic
net.netfilter.nf_conntrack_tcp_timeout_established = 3600

# ═══════════════════════════════════════════════════════════════════════════
# ADDITIONAL HARDENING
# ═══════════════════════════════════════════════════════════════════════════
# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Don't respond to ICMP broadcasts (smurf attack prevention)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Disable source routing (prevents IP source route attacks)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# TCP SYN cookies for SYN flood protection
net.ipv4.tcp_syncookies = 1
